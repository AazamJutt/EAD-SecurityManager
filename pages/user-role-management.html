<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User-Role Management</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="../SecurityManager.js"></script>
    <script>
        // Globals
        var editMode = false
        var editId = -1;

        function validateUserRoles(obj) {
            var userRoles = SecurityManager.GetAllUserRoles()
            console.log(userRoles)
            for (const userRole of userRoles) {
                if (userRole.Role == obj.Role && userRole.User == obj.User) {
                    return false
                }
            }
            return true
        }

        function getUserRolesId(obj) {
            var userRoles = SecurityManager.GetAllUserRoles()
            for (const userRole of userRoles) {
                if (userRole.Role == obj.Role) {
                    return userRole.ID
                }
            }
            return -1
        }

        function editUserRoles(id) {
            editMode = true
            var row = gid("user-roles").rows[Number(id) + 1]
            id = Number(row.cells[0].innerText)
            editId = id
            var ur = SecurityManager.GetUserRoleById(id)
            gid("select-user-role").value = ur.Role
            gid("select-user-role").disabled = true
            gid("select-user").value = ur.Permission
        }

        function deleteUserRoles(id) {
            var r = confirm("Are you sure you want to Delete?");
            if (r) {
                var row = gid("user-roles").rows[Number(id) + 1]
                id = Number(row.cells[0].innerText)
                SecurityManager.DeleteUserRole(Number(id), reload, error)
            } else {
                return;
            }
        }


        function saveUserRolesObject() {
            var userRole = {
                Role: gid("select-user-role").value,
                User: gid("select-user").value
            }
            console.log(userRole)
            if (!editMode && !validateUserRoles(userRole)) {
                alert("User-Role already exists")
                return false
            }
            else if (editMode) {
                // Add Id if object already exists
                if (editId != -1) {
                    userRole.ID = editId
                }

                editId = -1
                editMode = false
            }
            console.log(userRole)
            SecurityManager.SaveUserRole(userRole, reload, error);
        }

        function loadUsers() {
            var users = SecurityManager.GetAllUsers()
            var s = gid("select-user");
            for (const user of users) {
                var opt = document.createElement("option");
                opt.value = user.Name;
                opt.innerText = user.Name;
                s.appendChild(opt);
            }
        }

        function loadUserRoles() {
            loadRoleOptions(gid("select-user-role"))
            loadUsers()
            var table = gid("user-role-tbody");
            var data = SecurityManager.GetAllUserRoles()
            for (let i = 0; i < data.length; i++) {
                var row = document.createElement("tr");
                row.appendChild(getTD(data[i].ID))
                row.appendChild(getTD(data[i].Role))
                row.appendChild(getTD(data[i].User))
                row.innerHTML += `<td><button id=${i} class="edit-btn" onclick="editUserRoles(this.id)">Edit</button></td>`
                row.innerHTML += `<td><button id=${i} onclick="deleteUserRoles(this.id)" style="color:red;">Delete</button></td>`
                table.appendChild(row)
            }
        }
    </script>
</head>

<body onload="loadUserRoles()">
    <div class="bg-img"></div>
    <div class="nav">
        <a href="admin.html">Home</a>
        <a href="user-mangement.html">User Management</a>
        <a href="role-management.html">Role Management</a>
        <a href="permission-management.html">Permission Management</a>
        <a href="role-permission-management.html">Role-Permission Management</a>
        <a href="user-role-management.html">User-Role Management</a>
        <a href="../index.html">Logout</a>
    </div>
    <div class="content content-2">
        <div class="login-form">
            <h3>User-Role Management</h3>
            <form onsubmit="saveUserRolesObject()">
                <div class="form-content">
                    <label for="text">Role:</label>
                    <select id="select-user-role">
                    </select>
                    <label for="text">Users:</label>
                    <select id="select-user">
                    </select>
                </div>
                <div class="footer">
                    <input class="btn" type="submit" value="Save">
                </div>
            </form>
        </div>
        <table id="user-roles">
            <tr>
                <th>ID</th>
                <th>User</th>
                <th>Role</th>
                <th>Edit</th>
                <th>Delete</th>
            </tr>
            <tbody id="user-role-tbody"></tbody>
        </table>
    </div>
</body>

</html>